<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Etiqueta de Estoque</title>
  <style>
    :root {
      --bg-primary: #1e1f22;
      --bg-secondary: #2b2d30;
      --bg-hover: #3a3d41;
      --accent: #4c8bf5;
      --text-primary: #e0e0e0;
      --text-secondary: #b0b0b0;
      --border: #3a3a3a;
      --radius: 12px;
    }

    body {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }

    .container {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 40px;
      width: 850px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
    }

    h2 { text-align: center; color: #fff; margin-bottom: 20px; }

    label { display: block; color: var(--text-secondary); margin-bottom: 6px; }

    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-primary);
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    button {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.15s;
    }
    button:hover { background: #5b96ff; transform: scale(1.03); }
    button:disabled { background: #3a3a3a; cursor: not-allowed; }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border-bottom: 1px solid var(--border); padding: 10px; text-align: left; }
    th { background: #252628; color: #c9c9c9; text-transform: uppercase; font-size: 0.85rem; }
    tr:hover { background: var(--bg-hover); }
    tr.selected { background: #4c8bf5 !important; color: white; }

    .row {
      display: flex;
      gap: 30px;           /* mesmo espaçamento do expedição */
      align-items: flex-end;
      margin-bottom: 15px;
    }

    .result {
      margin-top: 15px;
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      display: none;
      transition: opacity 0.5s ease;
    }
    .result.success { background: #233026; border: 1px solid #3b543b; color: #b6f5b6; }
    .result.error { background: #3b2626; border: 1px solid #653939; color: #ffbfbf; }

    .back { display: inline-block; margin-top: 15px; text-decoration: none; color: var(--accent); }
  </style>
</head>
<body>
  <div class="container">
    <h2>Consulta e Impressão de Estoque</h2>

    <!-- Campos de quantidade, peso e número de etiquetas -->
    <div class="row">
      <div style="flex:1">
        <label for="qtd">Quantidade:</label>
        <input type="number" id="qtd" min="1" placeholder="">
      </div>
      <div style="flex:1">
        <label for="peso">Peso (opcional):</label>
        <input type="text" id="peso" placeholder="ex.: 12,5">
      </div>
      <div style="flex:1">
        <label for="n">№ Etiquetas:</label>
        <input type="number" id="n" min="1" value="1" placeholder="">
      </div>
    </div>

    <!-- Campo de busca e botões -->
    <label for="itemCode">Código do Item:</label>
    <input type="text" id="itemCode" placeholder="">

    <div class="row">
      <button id="btnBuscar">Buscar Itens</button>
      <button id="btnImprimir" disabled>Imprimir Selecionado</button>
      <div style="flex:1">
        <label for="printer">Impressora:</label>
        <select id="printer">
          <option value="expedicao">Impressora Expedição</option>
          <option value="galpao">Impressora Galpão</option>
        </select>
      </div>
    </div>

    <table id="tabelaItens" style="display:none;">
      <thead>
        <tr>
          <th>ItemCode</th>
          <th>Descrição</th>
          <th>Lote</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="result" id="resultBox"></div>
    <a href="{{ url_for('home') }}" class="back">⬅ Voltar</a>
  </div>

  <script>
    const btnBuscar = document.getElementById('btnBuscar');
    const btnImprimir = document.getElementById('btnImprimir');
    const tabela = document.getElementById('tabelaItens');
    const tbody = tabela.querySelector('tbody');
    const resultBox = document.getElementById('resultBox');

    let linhaSelecionada = null; // mantém a linha clicada + referência do select

    function showMessage(text, type = 'success') {
      resultBox.textContent = text;
      resultBox.className = 'result ' + type;
      resultBox.style.display = 'block';
      resultBox.style.opacity = '1';
      setTimeout(() => {
        resultBox.style.opacity = '0';
        setTimeout(() => (resultBox.style.display = 'none'), 500);
      }, 3000);
    }

    btnBuscar.addEventListener('click', async () => {
      const itemCode = document.getElementById('itemCode').value.trim();
      if (!itemCode) return alert("Digite o código do item");

      btnBuscar.disabled = true;
      btnBuscar.textContent = "Buscando...";
      btnImprimir.disabled = true;
      linhaSelecionada = null;
      resultBox.style.display = "none";

      try {
        const res = await fetch("/consulta/estoque", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ itemCode })
        });

        const data = await res.json();
        if (!res.ok) {
          showMessage(data.error || "Erro ao buscar itens", "error");
          tabela.style.display = "none";
          return;
        }

        tbody.innerHTML = "";
        data.forEach((row) => {
          const tr = document.createElement("tr");

          // cria o select de lotes
          const select = document.createElement("select");
          const lotes = (row.lotes_disponiveis || "")
            .split(",")
            .map(s => s.trim())
            .filter(Boolean);

          // fallback: se não houver listagem, usa o próprio lote do row (se existir)
          if (lotes.length === 0 && row.lote) {
            lotes.push(String(row.lote));
          }

          lotes.forEach(lote => {
            const option = document.createElement("option");
            option.value = lote;
            option.textContent = lote;
            if (row.lote && String(row.lote) === lote) option.selected = true;
            select.appendChild(option);
          });

          tr.innerHTML = `
            <td>${row.item_code || ''}</td>
            <td>${row.descricao || '(sem descrição)'}</td>
          `;
          const tdLote = document.createElement("td");
          tdLote.appendChild(select);
          tr.appendChild(tdLote);
          tbody.appendChild(tr);

          // clique na linha => seleciona corretamente
          tr.addEventListener("click", (e) => {
            if (e.target.tagName === 'SELECT') return; // não re-selecionar ao abrir o select

            [...tbody.querySelectorAll("tr")].forEach(l => l.classList.remove("selected"));
            tr.classList.add("selected");

            linhaSelecionada = {
              ...row,
              itemCode: row.item_code || row.ItemCode || row.ITEMCODE || "",
              lote: select.value,
              selectElement: select
            };
            btnImprimir.disabled = false;
          });

          // alterar lote no select atualiza o objeto se a linha estiver selecionada
          select.addEventListener("change", () => {
            if (tr.classList.contains("selected") && linhaSelecionada) {
              linhaSelecionada.lote = select.value;
            }
          });
        });

        tabela.style.display = "table";
        showMessage("Itens carregados com sucesso!");
      } catch (err) {
        showMessage("Erro: " + err.message, "error");
      } finally {
        btnBuscar.disabled = false;
        btnBuscar.textContent = "Buscar Itens";
      }
    });

    btnImprimir.addEventListener('click', async () => {
      if (!linhaSelecionada) return alert("Selecione um item primeiro.");

      const qtd = document.getElementById('qtd').value.trim();
      const peso = document.getElementById('peso').value.trim();
      const n = Number(document.getElementById('n').value.trim() || 1);
      const printer = document.getElementById('printer').value;

      if (!qtd) return alert("Informe a quantidade.");
      if (n < 1) return alert("Informe o número de etiquetas (n) ≥ 1.");

      // garante que usamos o valor atual do select de lote
      const loteAtual = linhaSelecionada.selectElement
        ? linhaSelecionada.selectElement.value
        : linhaSelecionada.lote;

      const payload = {
        itemCode: linhaSelecionada.itemCode,
        lote: loteAtual,
        qtd,
        peso,
        n,
        printer
      };

      console.log("Payload estoque =>", payload);

      try {
        btnImprimir.disabled = true;
        btnImprimir.textContent = "Imprimindo...";

        const resp = await fetch("/print/estoque", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const out = await resp.json();
        if (resp.ok) {
          showMessage(`Etiqueta inserida na fila de impressão ✅ (${n}x)`);
        } else {
          showMessage(out.error || "Erro ao imprimir etiqueta.", "error");
        }
      } catch (err) {
        showMessage("Erro: " + err.message, "error");
      } finally {
        btnImprimir.disabled = false;
        btnImprimir.textContent = "Imprimir Selecionado";
      }
    });
  </script>
</body>
</html>
