<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Expedição • Selecionar Lote e Imprimir</title>
  <style>
    :root {
      --bg-primary: #1e1f22;
      --bg-secondary: #2b2d30;
      --bg-hover: #3a3d41;
      --accent: #4c8bf5;
      --text-primary: #e0e0e0;
      --text-secondary: #b0b0b0;
      --border: #3a3a3a;
      --radius: 12px;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
    }

    .container {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 40px 50px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
      width: 850px;
    }

    h2 {
      text-align: center;
      color: #fff;
      margin-bottom: 20px;
    }

    label {
      display: block;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-primary);
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
    }

    button {
      background: var(--accent);
      border: none;
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s, transform 0.15s;
    }

    button:hover { background: #5b96ff; transform: scale(1.03); }
    button:disabled { background: #3a3a3a; cursor: not-allowed; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 0.9rem;
    }

    th, td {
      border-bottom: 1px solid var(--border);
      padding: 10px;
      text-align: left;
    }

    th {
      background: #252628;
      color: #c9c9c9;
      text-transform: uppercase;
      font-size: 0.85rem;
    }

    tr:hover { background: var(--bg-hover); }
    tr.selected { background: #4c8bf5 !important; color: white; }

    .result {
      margin-top: 20px;
      text-align: center;
      padding: 12px;
      border-radius: 8px;
      display: none;
      transition: opacity 0.5s ease;
    }

    .result.success {
      background: #233026;
      border: 1px solid #3b543b;
      color: #b6f5b6;
    }

    .result.error {
      background: #3b2626;
      border: 1px solid #653939;
      color: #ffbfbf;
    }

    .back {
      display: inline-block;
      margin-top: 15px;
      text-decoration: none;
      color: var(--accent);
    }

    .printer-box {
      margin-top: 10px;
      margin-bottom: 20px;
    }

    .input-group {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .input-small {
      width: 120px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Consulta e Impressão de Expedição</h2>

    <label for="pv">Número do Pedido de Venda:</label>
    <input type="text" id="pv" placeholder="">

    <div class="printer-box">
      <label for="printer">Selecione a Impressora:</label>
      <select id="printer">
        <option value="expedicao">Impressora Expedição</option>
        <option value="galpao">Impressora Galpão</option>
      </select>
    </div>

    <div class="input-group">
      <button id="btnBuscar">Buscar Itens</button>
      <button id="btnImprimir" disabled>Imprimir Selecionado</button>
      <div class="input-small">
        <label for="qtd">Qtd:</label>
        <input type="number" id="qtd" min="1" placeholder="">
      </div>
    </div>

    <table id="tabelaItens" style="display:none;">
      <thead>
        <tr>
          <th>ItemCode</th>
          <th>Descrição</th>
          <th>Quantidade Total Em ctos</th>
          <th>Lote</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="result" id="resultBox"></div>
    <a href="{{ url_for('home') }}" class="back">⬅ Voltar</a>
  </div>

  <script>
    const btnBuscar = document.getElementById('btnBuscar');
    const btnImprimir = document.getElementById('btnImprimir');
    const tabela = document.getElementById('tabelaItens');
    const tbody = tabela.querySelector('tbody');
    const resultBox = document.getElementById('resultBox');
    let linhaSelecionada = null;

    function showMessage(text, type = 'success') {
      resultBox.textContent = text;
      resultBox.className = 'result ' + type;
      resultBox.style.display = 'block';
      resultBox.style.opacity = '1';
      setTimeout(() => {
        resultBox.style.opacity = '0';
        setTimeout(() => (resultBox.style.display = 'none'), 500);
      }, 3000);
    }

    btnBuscar.addEventListener('click', async () => {
      const pv = document.getElementById('pv').value.trim();
      if (!pv) return alert("Digite o número do PV");

      btnBuscar.disabled = true;
      btnBuscar.textContent = "Buscando...";
      resultBox.style.display = "none";
      btnImprimir.disabled = true;
      linhaSelecionada = null;

      try {
        const res = await fetch("/consulta/expedicao", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pv })
        });

        const data = await res.json();

        if (!res.ok) {
          showMessage(data.error || "Erro ao buscar itens", "error");
          tabela.style.display = "none";
          return;
        }

        tbody.innerHTML = "";
        data.forEach(row => {
          const tr = document.createElement("tr");
          const lotes = row.lotes_disponiveis ? row.lotes_disponiveis.split(",") : [];
          const select = document.createElement("select");
          lotes.forEach(lote => {
            const option = document.createElement("option");
            option.value = lote.trim();
            option.textContent = lote.trim();
            select.appendChild(option);
          });

          tr.innerHTML = `
            <td>${row.item_code}</td>
            <td>${row.descricao || "(sem descrição)"}</td>
            <td>${row.qtd_total}</td>
          `;
          const tdLote = document.createElement("td");
          tdLote.appendChild(select);
          tr.appendChild(tdLote);
          tbody.appendChild(tr);

          tr.addEventListener("click", () => {
            [...tbody.querySelectorAll("tr")].forEach(l => l.classList.remove("selected"));
            tr.classList.add("selected");
            linhaSelecionada = { ...row, lote: select.value };
            btnImprimir.disabled = false;
          });

          select.addEventListener("change", () => {
            if (tr.classList.contains("selected")) {
              linhaSelecionada.lote = select.value;
            }
          });
        });

        tabela.style.display = "table";
        showMessage("Itens carregados com sucesso!");
      } catch (err) {
        showMessage("Erro: " + err.message, "error");
      } finally {
        btnBuscar.disabled = false;
        btnBuscar.textContent = "Buscar Itens";
      }
    });

    btnImprimir.addEventListener('click', async () => {
      if (!linhaSelecionada) return alert("Selecione um item primeiro.");
      const printer = document.getElementById('printer').value;
      const qtd = document.getElementById('qtd').value.trim();

      if (!qtd) return alert("Informe a quantidade a imprimir.");

      const payload = {
        pv: linhaSelecionada.pv,
        itemCode: linhaSelecionada.item_code,
        lote: linhaSelecionada.lote,
        qtd,
        printer
      };

      try {
        btnImprimir.disabled = true;
        btnImprimir.textContent = "Imprimindo...";

        const resp = await fetch("/print/expedicao", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const out = await resp.json();
        if (resp.ok) {
          showMessage("Etiqueta inserida na fila de impressão ✅");
        } else {
          showMessage(out.error || "Erro ao imprimir etiqueta.", "error");
        }
      } catch (err) {
        showMessage("Erro: " + err.message, "error");
      } finally {
        btnImprimir.disabled = false;
        btnImprimir.textContent = "Imprimir Selecionado";
      }
    });
  </script>
</body>
</html>
